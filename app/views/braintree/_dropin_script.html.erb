<script src="https://js.braintreegateway.com/web/dropin/<%= ENV['BRAINTREE_DROPIN_VERSION'] %>/js/dropin.min.js"></script>

<script>
  var button = document.querySelector('#pay-button');

  braintree.dropin.create({
    authorization: '<%= @client_token %>',
    container: '#dropin-container',
    form: '#checkout',
    vaultManager: true,
    card: {
      cardholderName: { required: true }
    },
    overrides: {
      fields: {
        cvv: true
      }
    },
    paypal: {
      flow: 'vault',
      buttonStyle: {
        color: 'blue',
        shape: 'rect',
        size: 'medium'
      }
    },
    applePay: {
      displayName: 'Birmingham Power Squadron',
      paymentRequest: {
        total: {
          label: 'Birmingham Power Squadron',
          amount: '<%= @payment.transaction_amount.tr('$', '') %>',
          type: 'final'
        }
      }
    }
  }, function (createErr, instance) {
    function sendNonceToServer() {
      instance.requestPaymentMethod(function (requestPaymentMethodErr, payload) {
        if (requestPaymentMethodErr) {
          // Handle errors
        }

        $.ajax({
          type: "POST",
          url: '<%= checkout_url %>',
          data: {
            'payment_method_nonce': payload.nonce,
            'token': '<%= @token %>',
            'email': $("#receipt-email").serialize()
          }
        });
      });
    }

    // Allows Drop-in to still request the payment method manually,
    // such as when filling out a credit card form.
    button.addEventListener('click', sendNonceToServer);

    instance.on('paymentMethodRequestable', function (event) {
      if (event.paymentMethodIsSelected) {
        // The customer has completed the flow and we are
        // ready to submit the payment method nonce to the server.
        sendNonceToServer();
      }
    });
  });

  $(document).ready(function() {
    $('#promo-code').click(() => window.location = `/pay/${$('#token').val()}/${$('#code').val()}`);
  });
</script>
